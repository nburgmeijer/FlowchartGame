name: Build Windows ARM64 MSI Installer

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-windows-arm64-msi:
    runs-on: windows-11-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install dependencies (pip only)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .
          python -m pip install PySDL2 pysdl2-dll
          python -m pip install pyinstaller

      - name: Verify SDL runtime payload from pip
        shell: pwsh
        run: |
          @'
          import importlib.util
          from pathlib import Path

          sdl2dll_count = 0
          for module in ("sdl2", "sdl2dll"):
              spec = importlib.util.find_spec(module)
              if spec is None:
                  raise SystemExit(f"Missing required module: {module}")
              roots = list(spec.submodule_search_locations or [])
              dlls = []
              for root in roots:
                  dlls.extend(Path(root).rglob("*.dll"))
              print(f"{module}: roots={roots}")
              print(f"{module}: dll_count={len(dlls)}")
              for dll in dlls[:10]:
                  print(f"  - {dll}")
              if module == "sdl2dll":
                  sdl2dll_count = len(dlls)

          if sdl2dll_count == 0:
              raise SystemExit(
                  "pysdl2-dll is installed but contains no DLL payload on this runner."
              )
          '@ | python -

      - name: Stage SDL DLLs for packaging
        shell: pwsh
        run: |
          @'
          import importlib.util
          import shutil
          from pathlib import Path

          dest = Path("third_party_sdl")
          dest.mkdir(parents=True, exist_ok=True)

          def collect_from_module(module_name: str) -> list[Path]:
              spec = importlib.util.find_spec(module_name)
              if spec is None:
                  return []
              roots = list(spec.submodule_search_locations or [])
              dlls = []
              for root in roots:
                  dlls.extend(Path(root).rglob("*.dll"))
              return dlls

          dlls = collect_from_module("sdl2dll") + collect_from_module("sdl2")
          by_name = {}
          for dll in dlls:
              key = dll.name.lower()
              if key not in by_name:
                  by_name[key] = dll

          required = ("sdl2.dll", "sdl2_ttf.dll")
          missing = [name for name in required if name not in by_name]
          if missing:
              raise SystemExit(f"Missing required SDL DLLs from pip payload: {missing}")

          for name in required:
              src = by_name[name]
              dst = dest / src.name
              shutil.copy2(src, dst)
              print(f"Staged {src} -> {dst}")
          '@ | python -

      - name: Create launcher script
        shell: pwsh
        run: |
          @'
          from flow_game.__main__ import main

          if __name__ == "__main__":
              main()
          '@ | Set-Content -Path launcher.py -Encoding UTF8

      - name: Build ARM64 onedir executable
        shell: pwsh
        run: |
          pyinstaller `
            --noconfirm `
            --clean `
            --onedir `
            --windowed `
            --name FlowchartGame-arm64 `
            --paths src `
            --collect-all sdl2 `
            --collect-all sdl2dll `
            --hidden-import sdl2.ext `
            --hidden-import sdl2.sdlttf `
            --add-binary "third_party_sdl/*.dll;." `
            launcher.py

      - name: Install WiX toolset
        shell: pwsh
        run: |
          $wixVersion = "6.0.2"
          dotnet tool install --global wix --version $wixVersion
          "$env:USERPROFILE\\.dotnet\\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          wix extension add WixToolset.UI.wixext/$wixVersion

      - name: Create WiX source
        shell: pwsh
        run: |
          @'
          <Wix
            xmlns="http://wixtoolset.org/schemas/v4/wxs"
            xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
            <Package
              Name="FlowchartGame"
              Manufacturer="Contributors"
              Version="0.1.0"
              UpgradeCode="C8DF6A6C-F9F5-4A8E-B81C-42A903D7114B"
              Scope="perMachine">
              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
              <MediaTemplate EmbedCab="yes" />
              <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
              <ui:WixUI Id="WixUI_InstallDir" />

              <StandardDirectory Id="ProgramMenuFolder">
                <Directory Id="ProgramMenuDir" Name="FlowchartGame" />
              </StandardDirectory>

              <StandardDirectory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="FlowchartGame">
                </Directory>
              </StandardDirectory>

              <ComponentGroup Id="AppFiles" Directory="INSTALLFOLDER">
                <Files Include="dist\FlowchartGame-arm64\**" />
              </ComponentGroup>

              <DirectoryRef Id="ProgramMenuDir">
                <Component Id="StartMenuShortcut" Guid="*">
                  <Shortcut
                    Id="FlowchartGameStartMenuShortcut"
                    Name="FlowchartGame"
                    Description="Flowchart learning game"
                    Target="[INSTALLFOLDER]FlowchartGame-arm64.exe"
                    WorkingDirectory="INSTALLFOLDER" />
                  <RemoveFolder Id="ProgramMenuDir" On="uninstall" />
                  <RegistryValue
                    Root="HKCU"
                    Key="Software\FlowchartGame"
                    Name="StartMenuShortcut"
                    Type="integer"
                    Value="1"
                    KeyPath="yes" />
                </Component>
              </DirectoryRef>

              <Feature Id="MainFeature" Title="FlowchartGame" Level="1">
                <ComponentGroupRef Id="AppFiles" />
                <ComponentRef Id="StartMenuShortcut" />
              </Feature>
            </Package>
          </Wix>
          '@ | Set-Content -Path installer.wxs -Encoding UTF8

      - name: Build ARM64 MSI installer
        shell: pwsh
        run: |
          wix build installer.wxs -ext WixToolset.UI.wixext -arch arm64 -o dist\FlowchartGame-arm64.msi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlowchartGame-windows-arm64-msi
          path: |
            dist/FlowchartGame-arm64.msi
            dist/FlowchartGame-arm64/**
            dist/*.cab
