name: Build Windows ARM64 MSI Installer

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-windows-arm64-msi:
    runs-on: windows-11-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[sdl2]"
          python -m pip install pyinstaller

      - name: Verify SDL runtime payload
        id: verify_sdl
        shell: pwsh
        run: |
          @'
          import json
          import importlib.util
          import os
          from pathlib import Path

          output = os.environ["GITHUB_OUTPUT"]
          missing = []
          sdl2dll_count = 0
          for module in ("sdl2", "sdl2dll"):
              spec = importlib.util.find_spec(module)
              if spec is None:
                  missing.append(module)
                  continue
              roots = list(spec.submodule_search_locations or [])
              dlls = []
              for root in roots:
                  dlls.extend(Path(root).rglob("*.dll"))
              print(f"{module}: roots={roots}")
              print(f"{module}: dll_count={len(dlls)}")
              for dll in dlls[:10]:
                  print(f"  - {dll}")
              if module == "sdl2dll":
                  sdl2dll_count = len(dlls)
          if missing:
              raise SystemExit(f"Missing required modules: {missing}")
          with open(output, "a", encoding="utf-8") as fh:
              fh.write(
                  f"need_sdl_fallback={'true' if sdl2dll_count == 0 else 'false'}\n"
              )
          '@ | python -

      - name: Download ARM64 SDL fallback DLLs
        if: steps.verify_sdl.outputs.need_sdl_fallback == 'true'
        shell: pwsh
        run: |
          @'
          import io
          import json
          import re
          import urllib.request
          import zipfile
          from pathlib import Path

          DEST = Path("third_party_sdl")
          DEST.mkdir(parents=True, exist_ok=True)

          def download_release_asset(repo: str, pattern: str) -> Path:
              api = f"https://api.github.com/repos/{repo}/releases/latest"
              with urllib.request.urlopen(api) as response:
                  data = json.load(response)
              assets = data.get("assets", [])
              regex = re.compile(pattern)
              for asset in assets:
                  name = asset.get("name", "")
                  if regex.search(name):
                      url = asset["browser_download_url"]
                      out = DEST / name
                      print(f"Downloading {name} from {url}")
                      with urllib.request.urlopen(url) as src:
                          out.write_bytes(src.read())
                      return out
              raise RuntimeError(f"No asset matching {pattern} for {repo}")

          def extract_dlls(zip_path: Path) -> None:
              with zipfile.ZipFile(zip_path) as zf:
                  for member in zf.namelist():
                      low = member.lower()
                      if not low.endswith(".dll"):
                          continue
                      if "arm64" not in low and "win32-arm64" not in low:
                          continue
                      target = DEST / Path(member).name
                      target.write_bytes(zf.read(member))

          # SDL2 runtime + SDL2_ttf runtime for Windows ARM64.
          sdl_zip = download_release_asset("libsdl-org/SDL", r"win32-arm64\.zip$")
          ttf_zip = download_release_asset("libsdl-org/SDL_ttf", r"win32-arm64\.zip$")
          extract_dlls(sdl_zip)
          extract_dlls(ttf_zip)

          dlls = sorted(DEST.glob("*.dll"))
          if not dlls:
              raise RuntimeError("SDL fallback download succeeded but no DLLs extracted.")
          print("Fallback SDL DLLs:")
          for dll in dlls:
              print(f" - {dll}")
          '@ | python -

      - name: Create launcher script
        shell: pwsh
        run: |
          @'
          from flow_game.__main__ import main

          if __name__ == "__main__":
              main()
          '@ | Set-Content -Path launcher.py -Encoding UTF8

      - name: Build ARM64 one-file executable
        shell: pwsh
        run: |
          $args = @(
            "--noconfirm",
            "--clean",
            "--onefile",
            "--windowed",
            "--name", "FlowchartGame-arm64",
            "--paths", "src",
            "--collect-all", "sdl2",
            "--collect-all", "sdl2dll",
            "--hidden-import", "sdl2.ext",
            "--hidden-import", "sdl2.sdlttf"
          )
          $fallbackDlls = Get-ChildItem -Path "third_party_sdl" -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($fallbackDlls) {
            $args += @("--add-binary", "third_party_sdl/*.dll;.")
          }
          $args += "launcher.py"
          pyinstaller @args

      - name: Install WiX toolset
        shell: pwsh
        run: |
          dotnet tool install --global wix
          "$env:USERPROFILE\\.dotnet\\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create WiX source
        shell: pwsh
        run: |
          @'
          <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
            <Package
              Name="FlowchartGame"
              Manufacturer="Contributors"
              Version="0.1.0"
              UpgradeCode="C8DF6A6C-F9F5-4A8E-B81C-42A903D7114B">
              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
              <MediaTemplate EmbedCab="yes" />

              <StandardDirectory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="FlowchartGame">
                  <Component Id="MainExecutable" Guid="*">
                    <File Id="FlowchartExe" Source="dist\FlowchartGame-arm64.exe" KeyPath="yes" />
                  </Component>
                </Directory>
              </StandardDirectory>

              <Feature Id="MainFeature" Title="FlowchartGame" Level="1">
                <ComponentRef Id="MainExecutable" />
              </Feature>
            </Package>
          </Wix>
          '@ | Set-Content -Path installer.wxs -Encoding UTF8

      - name: Build ARM64 MSI installer
        shell: pwsh
        run: |
          wix build installer.wxs -arch arm64 -o dist\FlowchartGame-arm64.msi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlowchartGame-windows-arm64-msi
          path: |
            dist/FlowchartGame-arm64.msi
            dist/FlowchartGame-arm64.exe
            dist/*.cab
